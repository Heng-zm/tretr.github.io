<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App with Voice Messages</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body class="bg-gray-100 flex justify-center items-center h-screen">

  <div class="w-full max-w-md bg-white shadow-lg rounded-lg p-6">
    <h1 class="text-2xl font-bold text-center mb-4">Chat App</h1>

    <!-- Chat Messages -->
    <div id="chat-container" class="h-60 overflow-y-auto border p-2 rounded bg-gray-100 mb-2"></div>

    <!-- Text Input & Send Button -->
    <div class="flex space-x-2">
      <input type="text" id="message-input" placeholder="Type a message..." class="w-full p-2 border rounded">
      <button id="send-btn" class="bg-blue-500 text-white px-4 py-2 rounded">Send</button>
    </div>

    <!-- Voice Message Buttons -->
    <div class="flex space-x-2 mt-2">
      <button id="record-btn" class="bg-red-500 text-white px-4 py-2 rounded">üéô Record</button>
      <button id="stop-btn" class="bg-gray-500 text-white px-4 py-2 rounded hidden">‚èπ Stop</button>
    </div>
  </div>

  <script>
    // üîπ Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBU_Q2F0zIMTrIyh5nXERtU3fEtlSX4SH0",
    authDomain: "mystical-slate-448113-c6.firebaseapp.com",
    projectId: "mystical-slate-448113-c6",
    storageBucket: "mystical-slate-448113-c6.firebasestorage.app",
    messagingSenderId: "681914071632",
    appId: "1:681914071632:web:35d31b8d1dafb51d51ef55",
    measurementId: "G-HQSH8R6RF9"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // DOM Elements
    const chatContainer = document.getElementById("chat-container");
    const messageInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const recordBtn = document.getElementById("record-btn");
    const stopBtn = document.getElementById("stop-btn");

    let mediaRecorder;
    let audioChunks = [];

    // ‚úÖ Load Messages
    function loadMessages() {
      db.collection("messages").orderBy("timestamp").onSnapshot((snapshot) => {
        chatContainer.innerHTML = "";
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.classList.add("p-2", "rounded", "mb-2", "bg-white", "shadow");

          if (msg.text) {
            div.innerHTML = `<strong>${msg.senderName}:</strong> ${msg.text}`;
          } else if (msg.audioUrl) {
            div.innerHTML = `<strong>${msg.senderName}:</strong> <audio controls src="${msg.audioUrl}"></audio>`;
          }

          chatContainer.appendChild(div);
        });
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });
    }
    loadMessages();

    // ‚úÖ Send Text Message
    sendBtn.addEventListener("click", async () => {
      const message = messageInput.value.trim();
      if (message === "") return;
      await db.collection("messages").add({
        text: message,
        senderName: "User",
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      messageInput.value = "";
    });

    // ‚úÖ Start Recording
    recordBtn.addEventListener("click", async () => {
      audioChunks = [];
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.start();

      mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const audioFile = new File([audioBlob], `voice_${Date.now()}.webm`, { type: "audio/webm" });

        // Upload to Firebase Storage
        const storageRef = storage.ref(`voice_messages/${audioFile.name}`);
        await storageRef.put(audioFile);
        const audioUrl = await storageRef.getDownloadURL();

        // Save to Firestore
        await db.collection("messages").add({
          senderName: "User",
          audioUrl,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("Voice message sent!");
      };

      recordBtn.classList.add("hidden");
      stopBtn.classList.remove("hidden");
    });

    // ‚úÖ Stop Recording
    stopBtn.addEventListener("click", () => {
      mediaRecorder.stop();
      recordBtn.classList.remove("hidden");
      stopBtn.classList.add("hidden");
    });
  </script>
</body>
</html>
